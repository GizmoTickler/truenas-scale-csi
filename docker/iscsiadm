#!/bin/bash

: "${ISCSIADM_HOST_STRATEGY:=nsenter}"
: "${ISCSIADM_HOST_PATH:=/usr/sbin/iscsiadm}"

echoerr() { printf "%s\n" "$*" >&2; }

case ${ISCSIADM_HOST_STRATEGY} in
  chroot)
    # https://engineering.docker.com/2019/07/road-to-containing-iscsi/
    # Use direct path instead of env for compatibility with minimal OS like Talos
    chroot /host ${ISCSIADM_HOST_PATH} "${@:1}"
    ;;

  nsenter)
    # https://github.com/siderolabs/extensions/issues/38#issuecomment-1125403043
    # Preferred method for Talos and other minimal OS
    # Use -x -o for busybox pgrep compatibility (not --exact --oldest)
    iscsid_pid=$(pgrep -x -o iscsid)
    if [[ "${iscsid_pid}x" == "x" ]]; then
      echoerr "failed to find iscsid pid for nsenter"
      exit 1
    fi
    nsenter --mount="/proc/${iscsid_pid}/ns/mnt" --net="/proc/${iscsid_pid}/ns/net" -- ${ISCSIADM_HOST_PATH} "${@:1}"
    ;;

  *)
    echoerr "invalid ISCSIADM_HOST_STRATEGY: ${ISCSIADM_HOST_STRATEGY}"
    exit 1
    ;;
esac
