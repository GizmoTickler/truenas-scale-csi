# Helm Chart Release Workflow (OCI)
# Publishes Helm charts to GitHub Container Registry as OCI artifacts
# Usage: helm pull oci://ghcr.io/gizmotickler/charts/truenas-csi --version <version>

name: Helm Chart Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'charts/**'
      - '.github/workflows/helm-release.yml'
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  CHART_NAME: truenas-csi

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v4.0.0

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get chart version
        id: chart_version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Use release tag version (strip 'v' prefix)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            # Use version from Chart.yaml for push events
            VERSION=$(grep '^version:' charts/${{ env.CHART_NAME }}/Chart.yaml | awk '{print $2}')
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Chart version: ${VERSION}"

      - name: Update chart version on release
        if: github.event_name == 'release'
        run: |
          VERSION="${{ steps.chart_version.outputs.version }}"

          # Update version and appVersion in Chart.yaml
          sed -i "s/^version:.*/version: ${VERSION}/" charts/${{ env.CHART_NAME }}/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" charts/${{ env.CHART_NAME }}/Chart.yaml

          echo "Updated Chart.yaml:"
          cat charts/${{ env.CHART_NAME }}/Chart.yaml

      - name: Lint chart
        run: helm lint charts/${{ env.CHART_NAME }}

      - name: Package chart
        run: |
          helm package charts/${{ env.CHART_NAME }} --destination .helm-packages

      - name: Push chart to OCI registry
        run: |
          helm push .helm-packages/${{ env.CHART_NAME }}-${{ steps.chart_version.outputs.version }}.tgz \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

          echo "Chart pushed to: oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }}:${{ steps.chart_version.outputs.version }}"
